<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sudoku.game ‚Äî Competitive PvP Sudoku</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Sudoku">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sudoku">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icon-144.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="96x96" href="icon-96.png">

    <!-- SEO -->
    <meta name="description" content="Lichess-style competitive Sudoku ‚Äî race a friend or AI to claim the most cells. Online multiplayer, offline play, PWA.">
    <meta property="og:title" content="Sudoku.game ‚Äî Competitive PvP Sudoku">
    <meta property="og:description" content="Race a friend or AI to solve a Sudoku. Claim cells, score points, win.">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">

    <!-- SW cleanup: unregister any old workers with wrong scope, then re-register -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs => {
          regs.forEach(reg => {
            // Remove any SW not scoped to our exact path
            if (!reg.scope.endsWith('/Sudoku.games/')) {
              reg.unregister();
              console.log('[SW] Unregistered stale SW:', reg.scope);
            }
          });
        });
      }
    </script>

    <!-- Styles (cached separately by SW) -->
    <link rel="stylesheet" href="style.css">

    <!-- Supabase (CDN, cached by SW after first load) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
    <!-- Animated Splash Screen -->
    <div id="splash-screen">
        <svg class="splash-wheel" viewBox="0 0 120 120" width="110" height="110">
            <!-- Outer ring -->
            <circle cx="60" cy="60" r="52" fill="none" stroke="#d59020" stroke-width="4" opacity="0.9"/>
            <!-- Inner ring -->
            <circle cx="60" cy="60" r="32" fill="none" stroke="#d59020" stroke-width="2.5" opacity="0.5"/>
            <!-- 9 spokes outer -->
            <line x1="60" y1="8"  x2="60" y2="28"  stroke="#d59020" stroke-width="2.5" opacity="0.9"/>
            <line x1="98" y1="21" x2="84" y2="35"  stroke="#d59020" stroke-width="2.5" opacity="0.7"/>
            <line x1="112" y1="60" x2="92" y2="60" stroke="#d59020" stroke-width="2.5" opacity="0.9"/>
            <line x1="98" y1="99" x2="84" y2="85"  stroke="#d59020" stroke-width="2.5" opacity="0.7"/>
            <line x1="60" y1="112" x2="60" y2="92" stroke="#d59020" stroke-width="2.5" opacity="0.9"/>
            <line x1="22" y1="99" x2="36" y2="85"  stroke="#d59020" stroke-width="2.5" opacity="0.7"/>
            <line x1="8"  y1="60" x2="28" y2="60"  stroke="#d59020" stroke-width="2.5" opacity="0.9"/>
            <line x1="22" y1="21" x2="36" y2="35"  stroke="#d59020" stroke-width="2.5" opacity="0.7"/>
            <!-- 9 inner spokes -->
            <line x1="60" y1="28" x2="60" y2="42"  stroke="#d59020" stroke-width="1.5" opacity="0.35"/>
            <line x1="84" y1="35" x2="74" y2="42"  stroke="#d59020" stroke-width="1.5" opacity="0.35"/>
            <line x1="92" y1="60" x2="78" y2="60"  stroke="#d59020" stroke-width="1.5" opacity="0.35"/>
            <line x1="84" y1="85" x2="74" y2="77"  stroke="#d59020" stroke-width="1.5" opacity="0.35"/>
            <line x1="60" y1="92" x2="60" y2="78"  stroke="#d59020" stroke-width="1.5" opacity="0.35"/>
            <line x1="36" y1="85" x2="46" y2="77"  stroke="#d59020" stroke-width="1.5" opacity="0.35"/>
            <line x1="28" y1="60" x2="42" y2="60"  stroke="#d59020" stroke-width="1.5" opacity="0.35"/>
            <line x1="36" y1="35" x2="46" y2="42"  stroke="#d59020" stroke-width="1.5" opacity="0.35"/>
            <!-- Motion blur dots -->
            <circle cx="60"  cy="8"  r="3.5" fill="#f0c840" opacity="0.9"/>
            <circle cx="75"  cy="10" r="2.5" fill="#f0c840" opacity="0.6"/>
            <circle cx="89"  cy="16" r="2"   fill="#f0c840" opacity="0.3"/>
            <!-- Hub -->
            <circle cx="60" cy="60" r="9" fill="#d59020"/>
            <circle cx="60" cy="60" r="5.5" fill="#161512"/>
            <!-- Stand -->
            <rect x="57" y="110" width="6" height="24" fill="#b08010" rx="2"/>
            <ellipse cx="60" cy="134" rx="20" ry="6" fill="#b08010" opacity="0.8"/>
            <ellipse cx="60" cy="132" rx="18" ry="4" fill="#161512" opacity="0.7"/>
        </svg>
        <div class="splash-title">Sudoku.game</div>
        <div class="splash-sub">Competitive PvP Sudoku</div>
    </div>
<!-- ============================================
         SIDE MENU
         ============================================ -->
    <div class="side-menu-overlay" id="side-menu-overlay"></div>
    <div class="side-menu" id="side-menu">
        <div class="side-menu-header">
            <div class="side-menu-user" id="side-menu-user-section">
                <div class="side-menu-avatar" id="menu-avatar">P</div>
                <div class="side-menu-user-info">
                    <div class="side-menu-username" id="menu-username">Player</div>
                    <div class="side-menu-rating" id="menu-rating">Rating: 2.0</div>
                </div>
            </div>
            <button class="auth-sign-in-btn" id="side-auth-btn">Sign In</button>
        </div>
        <nav class="side-menu-nav">
            <button class="side-menu-item active" data-page="lobby">
                <span class="side-menu-icon">üè†</span>
                <span>Quick Pairing</span>
            </button>
            <button class="side-menu-item" data-page="profile">
                <span class="side-menu-icon">üë§</span>
                <span>Profile</span>
            </button>
            <button class="side-menu-item" data-page="friends">
                <span class="side-menu-icon">ü§ù</span>
                <span>Friends</span>
                <span class="friends-badge" id="friends-badge" style="display:none;">0</span>
            </button>
            <button class="side-menu-item" data-page="leaderboard">
                <span class="side-menu-icon">üèÜ</span>
                <span>Leaderboard</span>
            </button>
            <button class="side-menu-item" data-page="tournaments">
                <span class="side-menu-icon">‚öîÔ∏è</span>
                <span>Tournaments</span>
                <span class="friends-badge" id="tournaments-badge" style="display:none;">0</span>
            </button>
            <button class="side-menu-item" data-page="history">
                <span class="side-menu-icon">üìä</span>
                <span>Game History</span>
            </button>
            <button class="side-menu-item" data-page="settings">
                <span class="side-menu-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
            <button class="side-menu-item side-menu-signout" id="side-signout-btn" style="display:none;">
                <span class="side-menu-icon">üö™</span>
                <span>Sign Out</span>
            </button>
        </nav>
    </div>

    <!-- ============================================
         LOBBY SCREEN
         ============================================ -->
    <div id="lobby">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <span class="logo">Sudoku.game</span>
            </div>
            <div class="header-right">
                <!-- Daily streak badge -->
                <div id="daily-streak-badge" class="streak-badge" title="Daily streak">
                    <span id="streak-flame">üî•</span>
                    <span id="streak-count">0</span>
                </div>
                <!-- Ongoing game thumbnail ‚Äî shown when a game is in progress -->
                <button id="ongoing-game-btn" title="Return to your game" style="display:none;">
                    <canvas id="ongoing-mini-board" width="36" height="36"></canvas>
                    <span class="ongoing-pulse"></span>
                </button>
                <button class="user-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <span class="notification-badge" id="notif-badge" style="display:none;">0</span>
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="quick">Quick Pairing</button>
            <button class="tab" data-tab="puzzles">Puzzles</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- Online Multiplayer ‚Äî TOP of lobby -->
            <div class="online-section">
                <div class="section-label">üåê Online Multiplayer</div>

                <div class="supabase-config" id="supabase-config-box" style="display:none;">
                    <div class="supabase-config-title">One-time setup ‚Äî connect to Supabase</div>
                    <input type="text" id="sb-url" placeholder="Project URL: https://xxxx.supabase.co" autocomplete="off" spellcheck="false">
                    <input type="text" id="sb-key" placeholder="Anon/public API key" autocomplete="off" spellcheck="false">
                    <div class="config-hint">
                        Free at <a href="https://supabase.com" target="_blank">supabase.com</a> ‚Üí New project ‚Üí Settings ‚Üí API.<br>
                        Then run this SQL once (SQL Editor tab):
                        <code style="background:#111;padding:8px;border-radius:5px;font-size:0.67rem;display:block;margin-top:6px;color:#9a9;white-space:pre;overflow-x:auto;">create table if not exists sudoku_rooms (
  id text primary key,
  state jsonb,
  updated_at timestamptz default now()
);
alter table sudoku_rooms enable row level security;
create policy "public rw" on sudoku_rooms
  for all using (true) with check (true);</code>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:8px;">
                        <div class="config-status idle" id="config-status">‚óè Not connected</div>
                        <button class="action-btn btn-primary" style="padding:8px 18px;margin:0;font-size:0.85rem;" id="sb-connect-btn">Connect</button>
                    </div>
                </div>

                <div id="online-buttons" style="display:flex;flex-direction:column;gap:8px;">
                    <button class="action-btn btn-online" id="find-opponent-btn">‚öî Find Opponent</button>
                    <div style="display:flex;gap:8px;">
                        <button class="action-btn btn-secondary" style="flex:1;" id="create-room-btn">üåê Create Room</button>
                        <button class="action-btn btn-secondary" style="flex:1;" id="join-room-btn">üîó Join Code</button>
                    </div>
                </div>
            </div>

            <!-- Time Controls -->
            <div class="section-label">Time Control</div>
            <div class="time-grid">
                <div class="time-card" data-time="120">
                    <div class="time-main">2+0</div>
                    <div class="time-label">Bullet</div>
                </div>
                <div class="time-card" data-time="300">
                    <div class="time-main">5+0</div>
                    <div class="time-label">Blitz</div>
                </div>
                <div class="time-card active" data-time="600">
                    <div class="time-main">10+0</div>
                    <div class="time-label">Rapid</div>
                </div>
                <div class="time-card" data-time="900">
                    <div class="time-main">15+0</div>
                    <div class="time-label">Rapid</div>
                </div>
                <div class="time-card" data-time="1200">
                    <div class="time-main">20+0</div>
                    <div class="time-label">Classical</div>
                </div>
                <div class="time-card" data-time="custom">
                    <div class="time-main">Custom</div>
                    <div class="time-label">Setup</div>
                </div>
            </div>

            <!-- Mode Selection -->
            <div class="mode-section">
                <div class="section-label">Game Mode</div>
                <div class="mode-grid">
                    <div class="mode-card active" data-mode="simultaneous">
                        <div class="mode-icon">‚ö°</div>
                        <div class="mode-info">
                            <div class="mode-name">Simultaneous</div>
                            <div class="mode-desc">Real-time race</div>
                        </div>
                    </div>
                    <div class="mode-card" data-mode="passplay">
                        <div class="mode-icon">üîÑ</div>
                        <div class="mode-info">
                            <div class="mode-name">Pass & Play</div>
                            <div class="mode-desc">Turn-based</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Variant Selection -->
            <div class="mode-section">
                <div class="section-label">Sudoku Variant</div>
                <div class="variant-pill-row" id="variant-grid">
                    <button class="variant-pill active" data-variant="classic">üü´ Classic</button>
                    <button class="variant-pill" data-variant="killer">üî¢ Killer</button>
                    <button class="variant-pill" data-variant="diagonal">‚úñ Diagonal</button>
                    <button class="variant-pill" data-variant="jigsaw">üß© Jigsaw</button>
                    <button class="variant-pill" data-variant="thermo">üå° Thermo</button>
                    <button class="variant-pill" data-variant="consecutive">‚Üî Consec.</button>
                    <button class="variant-pill" data-variant="arrow">‚û° Arrow</button>
                    <button class="variant-pill" data-variant="evenodd">‚¨° Even/Odd</button>
                    <button class="variant-pill" data-variant="windoku">ü™ü Windoku</button>
                    <button class="variant-pill" data-variant="antiknight">‚ôû Anti-Knight</button>
                </div>
                <div class="variant-desc-line" id="variant-desc">Standard 9√ó9 Sudoku ‚Äî rows, columns and boxes each contain 1‚Äì9.</div>
            </div>

            <!-- AI Toggle -->
            <div class="mode-section">
                <div class="section-label">Options</div>
                <div class="mode-card" id="ai-toggle-card" style="width: 100%;">
                    <div class="mode-icon">ü§ñ</div>
                    <div class="mode-info">
                        <div class="mode-name">Play vs Computer</div>
                        <div class="mode-desc">Tap to enable AI</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <button class="action-btn btn-primary" id="start-game-btn">Create a Game (Local)</button>
            <button class="action-btn btn-secondary" id="solo-sudoku-btn">üß© Solo Sudoku</button>

            <!-- Stats -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="online-players">‚Ä¶</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="active-games">‚Ä¶</div>
                    <div class="stat-label">Active Games</div>
                </div>
            </div>

            <!-- Tournaments (populated dynamically from Supabase) -->
            <div class="section-label">Live Tournaments</div>
            <div id="lobby-tournaments-list" class="list-section">
                <div style="color:#555;font-size:0.85rem;padding:12px 0;">Loading‚Ä¶</div>
            </div>
        </div>
    </div>

    <!-- ============================================
         SETTINGS PAGE
         ============================================ -->
    <div class="settings-page" id="settings-page">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" id="settings-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <span class="logo">Settings</span>
            </div>
        </header>

        <div class="main-content">
            <div class="page-header">
                <div class="page-title">Settings</div>
                <div class="page-subtitle">Customize your experience</div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Profile</div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Username</div>
                        <div class="setting-desc">Your display name</div>
                    </div>
                    <input type="text" class="setting-input" id="username-input" value="" maxlength="20">
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Game Preferences</div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Board Theme</div>
                        <div class="setting-desc">Choose your board colors</div>
                    </div>
                    <select class="setting-input" id="theme-select">
                        <option value="classic">Classic Chess</option>
                        <option value="wood">Wooden</option>
                        <option value="marble">Marble</option>
                        <option value="neon">Neon</option>
                        <option value="ocean">Ocean</option>
                        <option value="sunset">Sunset</option>
                        <option value="clean">Clean (Modern)</option>
                        <option value="night">Night (Modern)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Colour-Blind Mode</div>
                        <div class="setting-desc">Use shapes instead of colours to distinguish players</div>
                    </div>
                    <div class="toggle-switch" id="colorblind-toggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Sound Effects</div>
                        <div class="setting-desc">Play sounds during game</div>
                    </div>
                    <div class="toggle-switch active" id="sound-toggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Animations</div>
                        <div class="setting-desc">Cell claim animations</div>
                    </div>
                    <div class="toggle-switch active" id="animations-toggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Data</div>
                <div class="setting-item" style="cursor: pointer;" id="clear-history-btn">
                    <div class="setting-info">
                        <div class="setting-label">Clear Game History</div>
                        <div class="setting-desc">Remove all past games</div>
                    </div>
                    <span style="color: var(--accent-red);">Clear</span>
                </div>
                <div class="setting-item" style="cursor: pointer;" id="reset-rating-btn">
                    <div class="setting-info">
                        <div class="setting-label">Reset Rating</div>
                        <div class="setting-desc">Start from 2.0 again</div>
                    </div>
                    <span style="color: var(--accent-red);">Reset</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         PROFILE PAGE
         ============================================ -->
    <div class="profile-page" id="profile-page">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" id="profile-menu-btn">
                    <span></span><span></span><span></span>
                </button>
                <span class="logo">Profile</span>
            </div>
        </header>
        <div class="main-content">

            <!-- Avatar hero -->
            <div class="prof-hero">
                <div class="prof-avatar-wrap">
                    <img id="prof-avatar-img" class="prof-avatar-img" src="" alt="" style="display:none;">
                    <div id="prof-avatar-init" class="prof-avatar-init">P</div>
                    <label class="prof-avatar-edit-btn" id="prof-avatar-edit-lbl" title="Change photo" style="display:none;">
                        üì∑<input type="file" id="prof-avatar-file" accept="image/jpeg,image/png,image/webp,image/gif" style="display:none;">
                    </label>
                </div>
                <div class="prof-hero-text">
                    <div class="prof-hero-name" id="profile-username">Player</div>
                    <div class="prof-hero-since" id="profile-since">‚Äî</div>
                </div>
            </div>

            <!-- Stats grid -->
            <div class="profile-stats">
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profile-games">0</div>
                    <div class="profile-stat-label">Games</div>
                </div>
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profile-wins" style="color:#56d364;">0</div>
                    <div class="profile-stat-label">Wins</div>
                </div>
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profile-losses" style="color:#f05a5a;">0</div>
                    <div class="profile-stat-label">Losses</div>
                </div>
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profile-draws">0</div>
                    <div class="profile-stat-label">Draws</div>
                </div>
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profile-streak">0</div>
                    <div class="profile-stat-label">Win Streak</div>
                </div>
                <div class="profile-stat-card streak-card">
                    <div class="profile-stat-value" id="profile-daily-streak">0 üî•</div>
                    <div class="profile-stat-label">Daily Streak</div>
                </div>
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profile-best-streak">0</div>
                    <div class="profile-stat-label">Best Streak</div>
                </div>
            </div>

            <!-- TC ratings ‚Äî clean, no icons or descriptions -->
            <div class="section-label" style="margin-top:14px;">Ratings</div>
            <div class="tc-rating-grid">
                <div class="tc-rating-card">
                    <div class="tc-rating-name">Bullet</div>
                    <div class="tc-rating-val" id="tc-bullet">‚Äî</div>
                </div>
                <div class="tc-rating-card">
                    <div class="tc-rating-name">Blitz</div>
                    <div class="tc-rating-val" id="tc-blitz">‚Äî</div>
                </div>
                <div class="tc-rating-card">
                    <div class="tc-rating-name">Rapid</div>
                    <div class="tc-rating-val" id="tc-rapid">‚Äî</div>
                </div>
                <div class="tc-rating-card">
                    <div class="tc-rating-name">Classical</div>
                    <div class="tc-rating-val" id="tc-classical">‚Äî</div>
                </div>
            </div>

            <!-- Puzzle XP -->
            <div class="section-label" style="margin-top:14px;">Technique Dojo</div>
            <div class="puzzle-xp-row">
                <div class="puzzle-xp-rank" id="prof-puzzle-rank">üå± Beginner</div>
                <div class="puzzle-xp-bar-wrap">
                    <div class="puzzle-xp-bar" id="prof-puzzle-bar" style="width:0%"></div>
                </div>
                <div class="puzzle-xp-num"><span id="prof-puzzle-xp">0</span> XP</div>
            </div>

            <!-- Achievements -->
            <div class="section-label" style="margin-top:14px;">Achievements</div>
            <div class="profile-badges">
                <div class="badge-card locked" id="badge-first-win">
                    <div class="badge-icon">üèÜ</div>
                    <div class="badge-name">First Win</div>
                </div>
                <div class="badge-card locked" id="badge-winning-streak">
                    <div class="badge-icon">üî•</div>
                    <div class="badge-name">5 Win Streak</div>
                </div>
                <div class="badge-card locked" id="badge-master">
                    <div class="badge-icon">üëë</div>
                    <div class="badge-name">Rating 4.0+</div>
                </div>
                <div class="badge-card locked" id="badge-veteran">
                    <div class="badge-icon">‚≠ê</div>
                    <div class="badge-name">100 Games</div>
                </div>
                <div class="badge-card locked" id="badge-speedster">
                    <div class="badge-icon">‚ö°</div>
                    <div class="badge-name">Bullet Win</div>
                </div>
                <div class="badge-card locked" id="badge-expert">
                    <div class="badge-icon">üß†</div>
                    <div class="badge-name">Hard Win</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         HISTORY PAGE
         ============================================ -->
    <div class="history-page" id="history-page">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" id="history-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <span class="logo">History</span>
            </div>
        </header>

        <div class="main-content">
            <div class="page-header">
                <div class="page-title">Game History</div>
                <div class="page-subtitle">Your past games</div>
            </div>

            <div class="history-filters">
                <div class="filter-chip active" data-filter="all">All</div>
                <div class="filter-chip" data-filter="win">Wins</div>
                <div class="filter-chip" data-filter="loss">Losses</div>
                <div class="filter-chip" data-filter="draw">Draws</div>
                <div class="filter-chip" data-filter="easy">Easy</div>
                <div class="filter-chip" data-filter="medium">Medium</div>
                <div class="filter-chip" data-filter="hard">Hard</div>
            </div>

            <div class="history-list" id="history-list">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <div class="empty-state-text">No games played yet. Start your first game!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         LEADERBOARD PAGE
         ============================================ -->
    <div class="history-page" id="leaderboard-page">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" id="leaderboard-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <span class="logo">Leaderboard</span>
            </div>
        </header>

        <div class="main-content" style="padding-top:0;">
            <div class="friends-tabs" style="margin-bottom:0;">
                <button class="friends-tab active" data-lb="bullet">‚ö° Bullet</button>
                <button class="friends-tab" data-lb="blitz">üî• Blitz</button>
                <button class="friends-tab" data-lb="rapid">‚è± Rapid</button>
                <button class="friends-tab" data-lb="classical">‚ôü Classical</button>
            </div>
            <div class="leaderboard-list" id="leaderboard-list" style="padding-top:10px;">
                <!-- Leaderboard populated by JS -->
            </div>
        </div>
    </div>

    <!-- ============================================
         GAME SCREEN
         ============================================ -->
    <div id="game-screen">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" id="game-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <span class="logo">Sudoku.game</span>
            </div>
            <div class="header-right">
                <div class="ai-indicator" id="ai-indicator">
                    <span class="ai-dot"></span>
                    <span id="ai-diff-label">AI</span>
                </div>
                <div id="variant-badge" style="display:none;background:rgba(124,111,205,0.2);border:1px solid rgba(124,111,205,0.5);color:#a89fe8;font-size:0.65rem;font-weight:700;padding:3px 8px;border-radius:20px;letter-spacing:0.03em;"></div>
                <div class="online-badge" id="online-badge">
                    <span class="online-dot"></span>
                    <span>ONLINE</span>
                </div>
            </div>
        </header>

        <!-- Top Player Bar (Opponent) -->
        <div class="player-bar top">
            <div class="player-info">
                <div class="player-avatar p2">P2</div>
                <div class="player-details">
                    <div class="player-name" id="opponent-name">Opponent</div>
                    <div class="player-rating" id="opponent-rating"></div>
                </div>
            </div>
            <div class="player-score" id="p2-score">0</div>
            <div class="player-timer" id="p2-timer">10:00</div>
        </div>

        <!-- Game Board -->
        <div class="board-container">
            <canvas id="sudoku-canvas"></canvas>
            <div class="move-indicator" id="move-indicator">Opponent played!</div>
        </div>

        <!-- Bottom Player Bar (You) -->
        <div class="player-bar">
            <div class="player-info">
                <div class="player-avatar p1">P1</div>
                <div class="player-details">
                    <div class="player-name">You</div>
                    <div class="player-rating" id="p1-rating-display">Rating: 2.0</div>
                </div>
            </div>
            <div class="player-score" id="p1-score">0</div>
            <div class="player-timer" id="p1-timer">10:00</div>
        </div>

        <!-- Combined Bottom Bar: tools + number pad + actions in one tight area -->
        <div class="bottom-bar">
            <!-- Row 1: tools strip -->
            <div class="tools-strip">
                <div class="turn-indicator" id="turn-indicator">Your Turn</div>
                <button class="tool-btn active" id="pen-mode-btn" title="Pen">‚úèÔ∏è</button>
                <button class="tool-btn" id="pencil-mode-btn" title="Pencil">‚úé</button>
                <button class="tool-btn" id="erase-btn" title="Erase">‚å´</button>
                <div class="errors-badge">
                    <span id="wrong-moves-display" title="Wrong moves ‚Äî 3 = lose a point">‚óã‚óã‚óã</span>
                </div>
                <button class="tool-btn tool-btn-hint" id="hint-btn" title="Hint (reveals one safe cell)">üí°<span class="hint-count" id="hint-count">3</span></button>
                <button class="tool-btn tool-btn-resign" id="resign-btn" title="Resign">üè≥</button>
                <button class="tool-btn tool-btn-new" id="new-game-btn" title="New Game">‚Ü∫</button>
            </div>
            <!-- Row 2: number pad -->
            <div class="permanent-number-pad" id="permanent-number-pad">
                <button class="num-pad-btn" data-num="1">1<span class="num-remaining" id="remaining-1">9</span></button>
                <button class="num-pad-btn" data-num="2">2<span class="num-remaining" id="remaining-2">9</span></button>
                <button class="num-pad-btn" data-num="3">3<span class="num-remaining" id="remaining-3">9</span></button>
                <button class="num-pad-btn" data-num="4">4<span class="num-remaining" id="remaining-4">9</span></button>
                <button class="num-pad-btn" data-num="5">5<span class="num-remaining" id="remaining-5">9</span></button>
                <button class="num-pad-btn" data-num="6">6<span class="num-remaining" id="remaining-6">9</span></button>
                <button class="num-pad-btn" data-num="7">7<span class="num-remaining" id="remaining-7">9</span></button>
                <button class="num-pad-btn" data-num="8">8<span class="num-remaining" id="remaining-8">9</span></button>
                <button class="num-pad-btn" data-num="9">9<span class="num-remaining" id="remaining-9">9</span></button>
                <!-- 10-16 hidden initially; shown in 16x16 mode via rebuildNumberPad -->
            </div>
        </div>
    </div>

    <!-- ============================================
         NUMBER PICKER (DEPRECATED - keeping for compatibility)
         ============================================ -->
    <div class="number-picker" id="number-picker" style="display: none;">
        <div class="picker-title">Select a number</div>
        <div class="number-grid">
            <button class="number-btn" data-num="1">1</button>
            <button class="number-btn" data-num="2">2</button>
            <button class="number-btn" data-num="3">3</button>
            <button class="number-btn" data-num="4">4</button>
            <button class="number-btn" data-num="5">5</button>
            <button class="number-btn" data-num="6">6</button>
            <button class="number-btn" data-num="7">7</button>
            <button class="number-btn" data-num="8">8</button>
            <button class="number-btn" data-num="9">9</button>
            <button class="number-btn cancel" id="picker-close">Cancel</button>
        </div>
    </div>

    <!-- ============================================
         MODALS
         ============================================ -->
    
    <!-- AI Difficulty Modal -->
    <div class="modal-overlay" id="ai-difficulty-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">ü§ñ</div>
                <div class="modal-title">AI Opponent</div>
                <div class="modal-subtitle">Select difficulty level</div>
            </div>
            <div class="modal-body">
                <div class="difficulty-grid">
                    <button class="ai-difficulty-btn easy" data-ai-diff="easy">
                        <div class="ai-diff-title">Easy</div>
                        <div class="ai-diff-desc">Makes mistakes</div>
                        <div class="ai-diff-rating">~1500 rating</div>
                    </button>
                    <button class="ai-difficulty-btn medium" data-ai-diff="medium">
                        <div class="ai-diff-title">Medium</div>
                        <div class="ai-diff-desc">Balanced play</div>
                        <div class="ai-diff-rating">~2500 rating</div>
                    </button>
                    <button class="ai-difficulty-btn hard" data-ai-diff="hard">
                        <div class="ai-diff-title">Hard</div>
                        <div class="ai-diff-desc">Expert level</div>
                        <div class="ai-diff-rating">~4000 rating</div>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn btn-secondary" id="ai-difficulty-close">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Difficulty Modal (Puzzles) -->
    <div class="modal-overlay" id="difficulty-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">üß©</div>
                <div class="modal-title">Puzzle Mode</div>
                <div class="modal-subtitle">Select difficulty</div>
            </div>
            <div class="modal-body">
                <div class="difficulty-grid">
                    <button class="difficulty-btn easy"    data-diff="easy">Easy</button>
                    <button class="difficulty-btn medium"  data-diff="medium">Medium</button>
                    <button class="difficulty-btn hard"    data-diff="hard">Hard</button>
                    <button class="difficulty-btn extreme" data-diff="extreme">Extreme</button>
                    <button class="difficulty-btn size16"  data-diff="easy" data-size="16" style="grid-column:1/-1">16 √ó 16</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn btn-secondary" id="difficulty-close">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal-overlay" id="result-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="result-icon">üèÜ</div>
                <div class="modal-title" id="result-title">You Win!</div>
                <div class="modal-subtitle" id="result-subtitle">Most cells claimed</div>
            </div>
            <div class="modal-body">
                <!-- Solo summary grid (hidden in PvP mode) -->
                <div class="result-stats" id="solo-summary-stats" style="display:none;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
                    <div class="result-stat" style="border-color:var(--border-color);">
                        <div class="result-stat-value" id="sum-time" style="font-size:1.2rem;">‚Äî</div>
                        <div class="result-stat-label">Time</div>
                    </div>
                    <div class="result-stat" style="border-color:var(--border-color);">
                        <div class="result-stat-value" id="sum-mistakes" style="font-size:1.2rem;">0</div>
                        <div class="result-stat-label">Mistakes</div>
                    </div>
                    <div class="result-stat" style="border-color:var(--border-color);">
                        <div class="result-stat-value" id="sum-hints" style="font-size:1.2rem;">0</div>
                        <div class="result-stat-label">Hints Used</div>
                    </div>
                    <div class="result-stat" style="border-color:var(--border-color);grid-column:1/-1;">
                        <div class="result-stat-value" id="sum-best" style="font-size:0.9rem;color:var(--accent-orange);">‚Äî</div>
                        <div class="result-stat-label">Personal Best</div>
                    </div>
                </div>
                <div class="result-stats" id="pvp-summary-stats">
                    <div class="result-stat p1">
                        <div class="result-stat-value" id="p1-final-score">0</div>
                        <div class="result-stat-label">Your Cells</div>
                    </div>
                    <div class="result-stat p2">
                        <div class="result-stat-value" id="p2-final-score">0</div>
                        <div class="result-stat-label">Opponent</div>
                    </div>
                </div>
                </div><!-- /pvp-summary-stats -->
                <div class="rating-display">
                    <div class="rating-change" id="rating-change">
                        <span id="old-rating">2.0</span> ‚Üí <span id="new-rating">2.1</span>
                        <span id="rating-delta">(+0.1)</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn btn-primary" id="play-again-btn">Play Again</button>
                <button class="action-btn btn-share" id="share-result-btn">üì§ Share Result</button>
                <button class="action-btn btn-secondary" id="back-to-lobby-btn">Back to Lobby</button>
            </div>
        </div>
    </div>

    <!-- Waiting Room Overlay -->
    <div id="waiting-overlay">
        <div class="waiting-spinner"></div>
        <div class="waiting-title" id="waiting-title">Waiting for opponent‚Ä¶</div>
        <div id="waiting-room-section">
            <div class="room-code-display">
                <div class="room-code-label">Room Code</div>
                <div class="room-code-value" id="waiting-room-code">‚Äî‚Äî</div>
            </div>
            <div class="share-row">
                <input class="share-input" id="share-link-input" readonly value="">
                <button class="share-copy-btn" id="share-copy-btn">Copy Link</button>
            </div>
        </div>
        <div class="waiting-sub" id="waiting-sub">Share the link or room code with your opponent. The game starts automatically when they join.</div>
        <div id="matchmaking-status" style="display:none;">
            <div class="matchmaking-dots">
                <span></span><span></span><span></span>
            </div>
            <div class="matchmaking-info" id="matchmaking-info">Searching for a player at your rating‚Ä¶</div>
        </div>
        <button class="action-btn btn-secondary" style="width:200px;" id="cancel-waiting-btn">Cancel</button>
    </div>

    <!-- Join Room Modal -->
    <div class="modal-overlay" id="join-room-modal">
        <div class="modal" style="max-width:340px;">
            <div class="modal-header">
                <div class="modal-icon">üîó</div>
                <div class="modal-title">Join a Game</div>
                <div class="modal-subtitle">Enter the 6-letter room code</div>
            </div>
            <div class="modal-body" style="padding:20px;">
                <input type="text" id="join-code-input" maxlength="6"
                    placeholder="e.g. ABC123"
                    style="width:100%;padding:14px;background:var(--bg-tertiary);border:2px solid var(--border-color);border-radius:8px;color:var(--text-bright);font-size:1.6rem;font-weight:800;text-align:center;letter-spacing:6px;font-family:monospace;text-transform:uppercase;">
                <div id="join-error" style="color:var(--accent-red);font-size:0.8rem;margin-top:8px;min-height:18px;text-align:center;"></div>
            </div>
            <div class="modal-footer">
                <button class="action-btn btn-primary" id="join-confirm-btn">Join Game</button>
                <button class="action-btn btn-secondary" id="join-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- How to Play Modal -->
    <div class="modal-overlay" id="how-to-play-modal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <div class="modal-icon">üß©</div>
                <div class="modal-title">How to Play</div>
                <div class="modal-subtitle">Competitive Sudoku ‚Äî Race to claim cells!</div>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div style="display:flex;flex-direction:column;gap:16px;">
                    <div style="display:flex;gap:14px;align-items:flex-start;">
                        <div style="width:36px;height:36px;background:rgba(74,158,255,0.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;">üéØ</div>
                        <div>
                            <div style="font-weight:700;color:#fff;margin-bottom:4px;">Claim Cells to Score</div>
                            <div style="font-size:0.82rem;color:#8080a0;line-height:1.5;">Fill in the correct number in any empty cell to <span style="color:#4a9eff;">claim it for yourself</span>. Your opponent races to do the same. Most cells at the end wins!</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:14px;align-items:flex-start;">
                        <div style="width:36px;height:36px;background:rgba(240,90,90,0.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;">‚ö†Ô∏è</div>
                        <div>
                            <div style="font-weight:700;color:#fff;margin-bottom:4px;">Wrong Moves Cost You</div>
                            <div style="font-size:0.82rem;color:#8080a0;line-height:1.5;">Enter a wrong number and lose <strong style="color:#f05a5a;">10 seconds</strong> off your clock. Make 3 wrong moves in a row and you lose a point too. Watch the error counter: ‚óã‚óã‚óã</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:14px;align-items:flex-start;">
                        <div style="width:36px;height:36px;background:rgba(86,211,153,0.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;">‚è±Ô∏è</div>
                        <div>
                            <div style="font-weight:700;color:#fff;margin-bottom:4px;">Standard Sudoku Rules</div>
                            <div style="font-size:0.82rem;color:#8080a0;line-height:1.5;">Each row, column, and 3√ó3 box must contain the numbers 1‚Äì9 exactly once. Use <strong style="color:#769656;">Pencil mode</strong> to jot candidate numbers, and keyboard keys 1‚Äì9 + arrows for fast play.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn btn-primary" id="how-to-play-close">Got it ‚Äî Let's Play!</button>
            </div>
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" style="
        display:none; position:fixed; bottom:0; left:0; right:0; z-index:9000;
        background:#1e1c19; border-top:2px solid #d59020;
        padding:12px 16px; flex-direction:row; align-items:center; gap:12px;
        box-shadow:0 -4px 24px rgba(0,0,0,0.6);">
        <img src="icon-96.png" width="44" height="44" style="border-radius:10px;flex-shrink:0;" alt="">
        <div style="flex:1; min-width:0;">
            <div style="font-weight:700;color:#fff;font-size:0.9rem;">Add to Home Screen</div>
            <div style="color:#777;font-size:0.75rem;">Play offline, no browser chrome</div>
        </div>
        <button id="pwa-install-btn" style="
            background:#d59020;color:#161512;border:none;padding:8px 16px;
            border-radius:6px;font-weight:700;font-size:0.85rem;cursor:pointer;white-space:nowrap;">
            Install
        </button>
        <button id="pwa-dismiss-btn" style="
            background:none;border:none;color:#555;font-size:1.3rem;cursor:pointer;padding:4px;flex-shrink:0;">‚úï</button>
    </div>

    <!-- SW Update Toast -->
    <div id="sw-update-toast" style="
        display:none; position:fixed; top:12px; left:50%; transform:translateX(-50%);
        background:#262421; border:1px solid #d59020; border-radius:8px;
        padding:10px 16px; z-index:9001; align-items:center; gap:10px;
        box-shadow:0 4px 20px rgba(0,0,0,0.5); white-space:nowrap;">
        <span style="color:#bababa;font-size:0.82rem;">üîÑ Update available</span>
        <button id="sw-update-btn" style="
            background:#d59020;color:#161512;border:none;padding:5px 12px;
            border-radius:5px;font-weight:700;font-size:0.78rem;cursor:pointer;">
            Reload
        </button>
    </div>

    <!-- ============================================
         FRIENDS PAGE
         ============================================ -->
    <div class="history-page" id="friends-page">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" id="friends-menu-btn">
                    <span></span><span></span><span></span>
                </button>
                <span class="logo">Friends</span>
            </div>
        </header>
        <div class="main-content">
            <div class="page-header">
                <div class="page-title">Friends</div>
                <div class="page-subtitle">Challenge friends to a game</div>
            </div>

            <!-- Add friend -->
            <div class="friend-search-box">
                <input type="text" id="friend-search-input" placeholder="Search by username‚Ä¶" maxlength="30">
                <button id="friend-search-btn">Search</button>
            </div>
            <div id="friend-search-results"></div>

            <!-- Pending requests -->
            <div class="section-label" id="pending-label" style="display:none;">Pending Requests</div>
            <div id="pending-friends-list"></div>

            <!-- Friends list -->
            <div class="section-label">Your Friends</div>
            <div id="friends-list">
                <div class="empty-state" style="color:#555;">Loading‚Ä¶</div>
            </div>
        </div>
    </div>

    <!-- ============================================
         AUTH MODAL (Sign In / Sign Up)
         ============================================ -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal" style="max-width:360px;">
            <div class="modal-header">
                <div class="auth-wheel-icon">
                    <svg viewBox="0 0 80 80" width="64" height="64">
                        <circle cx="40" cy="40" r="30" fill="none" stroke="#d59020" stroke-width="3" opacity="0.9"/>
                        <circle cx="40" cy="40" r="18" fill="none" stroke="#d59020" stroke-width="2" opacity="0.5"/>
                        <g id="auth-spokes">
                            <line x1="40" y1="22" x2="40" y2="10" stroke="#d59020" stroke-width="2" opacity="0.9"/>
                            <line x1="56" y1="28" x2="65" y2="19" stroke="#d59020" stroke-width="2" opacity="0.7"/>
                            <line x1="62" y1="44" x2="74" y2="44" stroke="#d59020" stroke-width="2" opacity="0.9"/>
                            <line x1="56" y1="58" x2="65" y2="67" stroke="#d59020" stroke-width="2" opacity="0.7"/>
                            <line x1="40" y1="62" x2="40" y2="74" stroke="#d59020" stroke-width="2" opacity="0.9"/>
                            <line x1="24" y1="58" x2="15" y2="67" stroke="#d59020" stroke-width="2" opacity="0.7"/>
                            <line x1="18" y1="44" x2="6" y2="44" stroke="#d59020" stroke-width="2" opacity="0.9"/>
                            <line x1="24" y1="28" x2="15" y2="19" stroke="#d59020" stroke-width="2" opacity="0.7"/>
                            <line x1="40" y1="22" x2="40" y2="34" stroke="#d59020" stroke-width="1.5" opacity="0.4"/>
                            <line x1="56" y1="28" x2="47" y2="34" stroke="#d59020" stroke-width="1.5" opacity="0.4"/>
                            <line x1="62" y1="44" x2="51" y2="44" stroke="#d59020" stroke-width="1.5" opacity="0.4"/>
                            <line x1="56" y1="58" x2="47" y2="51" stroke="#d59020" stroke-width="1.5" opacity="0.4"/>
                            <line x1="40" y1="62" x2="40" y2="51" stroke="#d59020" stroke-width="1.5" opacity="0.4"/>
                            <line x1="24" y1="58" x2="33" y2="51" stroke="#d59020" stroke-width="1.5" opacity="0.4"/>
                            <line x1="18" y1="44" x2="29" y2="44" stroke="#d59020" stroke-width="1.5" opacity="0.4"/>
                            <line x1="24" y1="28" x2="33" y2="34" stroke="#d59020" stroke-width="1.5" opacity="0.4"/>
                        </g>
                        <circle cx="40" cy="40" r="5" fill="#d59020"/>
                        <circle cx="40" cy="40" r="3" fill="#161512"/>
                    </svg>
                </div>
                <div class="modal-title" id="auth-title">Welcome to Sudoku.game</div>
                <div class="modal-subtitle" id="auth-subtitle">Sign in to save your rating across devices</div>
            </div>
            <div class="modal-body" style="padding:20px;display:flex;flex-direction:column;gap:12px;">
                <div id="auth-username-row" style="display:none;">
                    <input type="text" class="auth-input" id="auth-username" placeholder="Choose a username" maxlength="20" autocomplete="username">
                </div>
                <input type="email" class="auth-input" id="auth-email" placeholder="Email address" autocomplete="email">
                <input type="password" class="auth-input" id="auth-password" placeholder="Password (6+ characters)" autocomplete="current-password">
                <div id="auth-error" style="color:var(--accent-red);font-size:0.78rem;min-height:16px;text-align:center;"></div>
                <button class="action-btn btn-primary" id="auth-submit-btn">Sign In</button>
                <button class="action-btn btn-secondary" id="auth-toggle-btn">No account? Sign Up</button>
                <button class="action-btn" id="auth-skip-btn" style="background:none;color:var(--text-muted);font-size:0.8rem;padding:6px;">Continue as guest</button>
            </div>
        </div>
    </div>


    <!-- ============================================
         TOURNAMENTS PAGE
         ============================================ -->
    <div class="history-page" id="tournaments-page">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" id="tournaments-menu-btn">
                    <span></span><span></span><span></span>
                </button>
                <span class="logo">Tournaments</span>
            </div>
            <button id="create-tournament-btn" style="
                background:#d59020;color:#161512;border:none;padding:7px 14px;
                border-radius:7px;font-weight:700;font-size:0.82rem;cursor:pointer;">
                + Create
            </button>
        </header>
        <div class="main-content">

            <!-- Active tournaments -->
            <div class="page-header">
                <div class="page-title">Live &amp; Upcoming</div>
                <div class="page-subtitle">Join a tournament or create your own</div>
            </div>
            <div id="tournaments-list">
                <div class="empty-state" style="padding:40px 0;color:#555;">Loading‚Ä¶</div>
            </div>

            <!-- Past tournaments -->
            <div class="section-label" style="margin-top:24px;">Recently Ended</div>
            <div id="tournaments-past">
                <div class="empty-state" style="color:#555;">‚Äî</div>
            </div>
        </div>
    </div>

    <!-- Create Tournament Modal -->
    <div class="modal-overlay" id="create-tournament-modal">
        <div class="modal" style="max-width:380px;">
            <div class="modal-header">
                <div class="modal-title">Create Tournament</div>
                <div class="modal-subtitle">Set up and schedule your tournament</div>
            </div>
            <div class="modal-body" style="padding:20px;display:flex;flex-direction:column;gap:14px;">
                <input type="text" class="auth-input" id="t-name" placeholder="Tournament name" maxlength="50">

                <select class="auth-input" id="t-time-control" style="background:#262421;color:#bababa;border:1px solid #3a3a3a;">
                    <option value="2+0">2+0 Bullet</option>
                    <option value="5+0" selected>5+0 Blitz</option>
                    <option value="10+0">10+0 Rapid</option>
                    <option value="15+0">15+0 Rapid</option>
                    <option value="20+0">20+0 Classical</option>
                </select>

                <select class="auth-input" id="t-icon" style="background:#262421;color:#bababa;border:1px solid #3a3a3a;">
                    <option value="trophy">üèÜ Trophy</option>
                    <option value="fire">üî• Fire</option>
                    <option value="bolt">‚ö° Bolt</option>
                    <option value="star">‚≠ê Star</option>
                    <option value="crown">üëë Crown</option>
                </select>

                <div style="display:flex;flex-direction:column;gap:6px;">
                    <label style="color:#777;font-size:0.8rem;">Start</label>
                    <select class="auth-input" id="t-start-mode" style="background:#262421;color:#bababa;border:1px solid #3a3a3a;" onchange="toggleScheduled()">
                        <option value="now">Start immediately when I launch it</option>
                        <option value="scheduled">Schedule for later</option>
                    </select>
                </div>

                <div id="t-schedule-row" style="display:none;flex-direction:column;gap:6px;">
                    <label style="color:#777;font-size:0.8rem;">Scheduled start time</label>
                    <input type="datetime-local" class="auth-input" id="t-scheduled-at"
                        style="background:#262421;color:#bababa;border:1px solid #3a3a3a;">
                </div>

                <div style="display:flex;flex-direction:column;gap:6px;">
                    <label style="color:#777;font-size:0.8rem;">Duration (after start)</label>
                    <select class="auth-input" id="t-duration" style="background:#262421;color:#bababa;border:1px solid #3a3a3a;">
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="120" selected>2 hours</option>
                        <option value="360">6 hours</option>
                        <option value="1440">24 hours</option>
                    </select>
                </div>

                <div style="display:flex;gap:12px;">
                    <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                        <label style="color:#777;font-size:0.8rem;">Min players</label>
                        <select class="auth-input" id="t-min-players" style="background:#262421;color:#bababa;border:1px solid #3a3a3a;">
                            <option value="2" selected>2</option>
                            <option value="4">4</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                        <label style="color:#777;font-size:0.8rem;">Max players</label>
                        <select class="auth-input" id="t-max-players" style="background:#262421;color:#bababa;border:1px solid #3a3a3a;">
                            <option value="8">8</option>
                            <option value="16" selected>16</option>
                            <option value="32">32</option>
                            <option value="64">64</option>
                        </select>
                    </div>
                </div>

                <div id="create-tournament-error" style="color:#c55;font-size:0.78rem;min-height:16px;"></div>
                <button class="action-btn btn-primary" id="create-tournament-submit">Create Tournament</button>
                <button class="action-btn btn-secondary" id="create-tournament-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Tournament Detail Modal -->
    <div class="modal-overlay" id="tournament-detail-modal">
        <div class="modal" style="max-width:420px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header">
                <div class="modal-title" id="td-name">Tournament</div>
                <div class="modal-subtitle" id="td-meta"></div>
            </div>
            <div class="modal-body" style="padding:20px;display:flex;flex-direction:column;gap:14px;">

                <!-- Stats row -->
                <div style="display:flex;justify-content:space-around;background:#1a1816;border-radius:10px;padding:14px;">
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:800;color:#d59020;" id="td-players">0</div>
                        <div style="font-size:0.72rem;color:#777;">Players</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:800;color:#d59020;" id="td-status-badge">Waiting</div>
                        <div style="font-size:0.72rem;color:#777;">Status</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:800;color:#d59020;" id="td-time-left">‚Äî</div>
                        <div style="font-size:0.72rem;color:#777;" id="td-time-label">Starts in</div>
                    </div>
                </div>

                <!-- Min players notice -->
                <div id="td-min-notice" style="background:rgba(213,144,32,0.08);border:1px solid rgba(213,144,32,0.2);border-radius:8px;padding:10px 12px;font-size:0.8rem;color:#bababa;display:none;">
                    ‚ö† Tournament needs at least <span id="td-min-num">2</span> players to start.
                </div>

                <!-- Participants list -->
                <div>
                    <div style="font-size:0.75rem;color:#777;font-weight:700;letter-spacing:1px;margin-bottom:8px;">PARTICIPANTS</div>
                    <div id="td-participants" style="display:flex;flex-direction:column;gap:6px;max-height:160px;overflow-y:auto;"></div>
                </div>

                <!-- Matches / bracket -->
                <div id="td-matches-section" style="display:none;">
                    <div style="font-size:0.75rem;color:#777;font-weight:700;letter-spacing:1px;margin-bottom:8px;">ROUND <span id="td-round-num">1</span> MATCHES</div>
                    <div id="td-matches" style="display:flex;flex-direction:column;gap:8px;"></div>
                </div>

                <!-- Share link -->
                <div style="display:flex;gap:8px;align-items:center;background:#1a1816;border-radius:8px;padding:10px 12px;">
                    <div style="flex:1;font-size:0.78rem;color:#bababa;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="td-link"></div>
                    <button onclick="copyTournamentLink()" style="background:#d59020;color:#161512;border:none;padding:5px 10px;border-radius:5px;font-size:0.75rem;font-weight:700;cursor:pointer;white-space:nowrap;">Copy</button>
                </div>

                <button class="action-btn btn-primary" id="td-join-btn">Join Tournament</button>
                <button class="action-btn btn-primary" id="td-launch-btn" style="display:none;background:#2a7a2a;">üöÄ Launch Tournament</button>
                <button class="action-btn btn-secondary" id="td-leave-btn" style="display:none;">Leave Tournament</button>
                <button class="action-btn btn-secondary" id="td-delete-btn" style="display:none;background:rgba(220,50,50,0.15);color:#f05a5a;border-color:#f05a5a;">üóë Delete Tournament</button>
                <button class="action-btn btn-secondary" id="td-close-btn">Close</button>
            </div>
        </div>
    </div>


    <!-- Player Profile Modal -->
    <div class="modal-overlay" id="player-profile-modal">
        <div class="modal" style="max-width:360px;">
            <div class="modal-header" style="position:relative;">
                <div style="display:flex;align-items:center;gap:14px;">
                    <div id="pp-avatar" style="width:52px;height:52px;border-radius:50%;background:#d59020;display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0;">?</div>
                    <div>
                        <div id="pp-username" class="modal-title" style="margin:0;font-size:1.1rem;"></div>
                        <div id="pp-online" style="font-size:0.75rem;color:#777;"></div>
                    </div>
                </div>
                <button onclick="document.getElementById('player-profile-modal').classList.remove('active')"
                    style="position:absolute;top:0;right:0;background:none;border:none;color:#777;font-size:1.4rem;cursor:pointer;padding:4px 8px;">‚úï</button>
            </div>
            <div class="modal-body" style="padding:16px 20px;display:flex;flex-direction:column;gap:10px;">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;text-align:center;">
                    <div style="background:#1a1816;border-radius:8px;padding:8px 4px;">
                        <div id="pp-bullet" style="font-size:1rem;font-weight:700;color:#d59020;">‚Äî</div>
                        <div style="font-size:0.6rem;color:#555;margin-top:2px;">BULLET</div>
                    </div>
                    <div style="background:#1a1816;border-radius:8px;padding:8px 4px;">
                        <div id="pp-blitz" style="font-size:1rem;font-weight:700;color:#d59020;">‚Äî</div>
                        <div style="font-size:0.6rem;color:#555;margin-top:2px;">BLITZ</div>
                    </div>
                    <div style="background:#1a1816;border-radius:8px;padding:8px 4px;">
                        <div id="pp-rapid" style="font-size:1rem;font-weight:700;color:#d59020;">‚Äî</div>
                        <div style="font-size:0.6rem;color:#555;margin-top:2px;">RAPID</div>
                    </div>
                    <div style="background:#1a1816;border-radius:8px;padding:8px 4px;">
                        <div id="pp-classical" style="font-size:1rem;font-weight:700;color:#d59020;">‚Äî</div>
                        <div style="font-size:0.6rem;color:#555;margin-top:2px;">CLASS.</div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;text-align:center;">
                    <div style="background:#1a1816;border-radius:8px;padding:8px 4px;">
                        <div id="pp-wins" style="font-size:1.1rem;font-weight:700;color:#56d364;">‚Äî</div>
                        <div style="font-size:0.6rem;color:#555;margin-top:2px;">WINS</div>
                    </div>
                    <div style="background:#1a1816;border-radius:8px;padding:8px 4px;">
                        <div id="pp-games" style="font-size:1.1rem;font-weight:700;color:#bababa;">‚Äî</div>
                        <div style="font-size:0.6rem;color:#555;margin-top:2px;">GAMES</div>
                    </div>
                    <div style="background:#1a1816;border-radius:8px;padding:8px 4px;">
                        <div id="pp-streak" style="font-size:1.1rem;font-weight:700;color:#f78166;">‚Äî</div>
                        <div style="font-size:0.6rem;color:#555;margin-top:2px;">STREAK</div>
                    </div>
                </div>
                <div>
                    <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:#555;margin-bottom:4px;">
                        <span>Win rate</span><span id="pp-winrate-pct">‚Äî</span>
                    </div>
                    <div style="height:6px;background:#2a2826;border-radius:3px;overflow:hidden;">
                        <div id="pp-winrate-bar" style="height:100%;background:#d59020;border-radius:3px;width:0%;transition:width 0.4s ease;"></div>
                    </div>
                </div>
                <div id="pp-actions" style="display:flex;gap:8px;margin-top:4px;"></div>
            </div>
        </div>
    </div>

    <!-- Penalty toast -->
    <div id="penalty-toast"></div>

    <!-- Game script (cached separately by SW) -->
    <script src="app.js" defer></script>
</body>
</html>